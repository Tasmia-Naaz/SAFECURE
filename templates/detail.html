<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultation Report - SafeCure</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4A90E2;
            --secondary-color: #00BFA5;
            --accent-color: #F44336;
            --success-color: #4CAF50;
            --light-bg: #F5F5F5;
            --white: #FFFFFF;
            --light-grey: #F5F5F5;
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text fill="%234A90E2" fill-opacity="0.03" font-size="20" y="50%">ðŸ©º</text></svg>');
            background-repeat: repeat;
            background-size: 80px 80px;
        }

        .navbar {
            background-color: var(--white);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            color: var(--primary-color) !important;
            font-weight: 600;
        }

        .nav-link {
            color: var(--primary-color) !important;
        }

        .nav-link:hover {
            color: var(--secondary-color) !important;
        }

        .report-header {
            background-color: var(--primary-color);
            color: white;
            padding: 40px 0;
            margin-bottom: 30px;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .status-badge {
            font-size: 1.2rem;
            padding: 10px 20px;
            border-radius: 50px;
        }
        
        .appropriate {
            background-color: #d4edda;
            color: #155724;
        }
        
        .verification-needed {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .section-title {
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        .risk-item, .indication-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            background-color: #f8f9fa;
            border-left: 3px solid var(--primary-color);
            border-radius: 5px;
        }
        
        .myth-card {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .fact-card {
            background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .urgency-box {
            background-color: #ffe5e5;
            border: 2px solid #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .recovery-box {
            background-color: #e8f5e9;
            border: 2px solid #4caf50;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .print-btn {
            border-radius: 50px;
            padding: 10px 30px;
        }
        
        .alternative-card {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }

        .guideline-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 10px;
        }

        .evidence-level {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .biomarker-box {
            background: linear-gradient(135deg, #fff9e6 0%, #ffeb99 100%);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
        }

        .contraindication-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            background-color: #ffebee;
            border-left: 3px solid #f44336;
            border-radius: 5px;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            .navbar {
                display: none !important;
            }
            .card {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
            }
            body {
                background-color: white;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark no-print">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-heartbeat"></i> SafeCure
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard"><i class="fas fa-home"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/consultation"><i class="fas fa-stethoscope"></i> New Consultation</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/history"><i class="fas fa-history"></i> History</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="report-header">
        <div class="container">
            <h1><i class="fas fa-file-medical-alt"></i> Consultation Report</h1>
            <p class="lead mb-0">Detailed analysis of your second opinion request</p>
        </div>
    </div>

    <div class="container mb-5">
        {% if result.status == 'found' %}
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <!-- Report Header Info -->
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong><i class="fas fa-calendar"></i> Date:</strong> {{ consultation.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                                <p><strong><i class="fas fa-id-card"></i> Report ID:</strong> #{{ consultation.id }}</p>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <p><strong><i class="fas fa-user"></i> Patient:</strong> {{ session.user_name }}</p>
                                <p><strong><i class="fas fa-prescription"></i> Treatment:</strong> {{ consultation.recommended_treatment }}</p>
                            </div>
                        </div>
                        
                        <!-- Guideline Source Badge -->
                        {% if result.guideline_source %}
                        <div class="text-center mt-3">
                            <span class="guideline-badge">
                                <i class="fas fa-book-medical"></i> Analysis Based on {{ result.guideline_source }}
                            </span>
                            {% if result.guideline_url %}
                            <div class="mt-2">
                                <a href="{{ result.guideline_url }}" target="_blank" class="text-primary small">
                                    <i class="fas fa-external-link-alt"></i> View Official Guidelines
                                </a>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Treatment Status -->
                <div class="card">
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            {% if result.cancer_type %}
                            <h3 class="mb-2">{{ result.cancer_type }}</h3>
                            {% if result.stage %}
                            <p class="mb-2" style="font-size: 1.3rem; font-weight: 600; color: #667eea;">{{ result.stage }}</p>
                            {% if result.stage_description %}
                            <p style="font-size: 1.1rem; color: #555; font-weight: 500; margin-bottom: 20px;">{{ result.stage_description }}</p>
                            {% endif %}
                            {% endif %}
                            {% else %}
                            <h3 class="mb-3">{{ result.treatment_name }}</h3>
                            {% endif %}
                            
                            <div class="mt-3">
                                <span class="status-badge {% if 'Aligned' in result.get('alignment', result.get('appropriateness', '')) %}appropriate{% else %}verification-needed{% endif %}">
                                    <i class="fas {% if 'Aligned' in result.get('alignment', result.get('appropriateness', '')) %}fa-check-circle{% else %}fa-exclamation-triangle{% endif %}"></i>
                                    {{ result.get('alignment', result.get('appropriateness', 'Status Unknown')) }}
                                </span>
                            </div>
                            {% if result.ml_confidence %}
                            <div class="mt-2">
                                <small class="text-muted">ML Confidence: {{ "%.1f"|format(result.ml_confidence * 100) }}%</small>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Evidence Level (for guideline-based results) -->
                        {% if result.evidence_level %}
                        <div class="evidence-level">
                            <strong><i class="fas fa-certificate"></i> Evidence Level:</strong> {{ result.evidence_level }}
                            {% if result.alignment_details %}
                            <p class="mb-0 mt-2 small">{{ result.alignment_details }}</p>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="alert alert-info">
                            <strong><i class="fas fa-info-circle"></i> Your Input:</strong>
                            <p class="mb-0 mt-2">{{ consultation.symptoms }}</p>
                        </div>
                    </div>
                </div>

                <!-- Biomarker Tests Required (for guideline-based results) -->
                {% if result.biomarker_tests_required %}
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title"><i class="fas fa-microscope"></i> Required Biomarker Tests</h5>
                        <div class="biomarker-box">
                            <p class="mb-2"><strong>Essential tests before treatment:</strong></p>
                            <ul class="mb-0">
                                {% for test in result.biomarker_tests_required %}
                                <li>{{ test }}</li>
                                {% endfor %}
                            </ul>
                            {% if result.special_notes %}
                            <p class="mt-3 mb-0"><small><i class="fas fa-info-circle"></i> {{ result.special_notes }}</small></p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Standard Treatment (for guideline-based results) -->
                {% if result.standard_treatment %}
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title"><i class="fas fa-procedures"></i> Standard Treatment According to Guidelines</h5>
                        <div class="alert alert-success">
                            {{ result.standard_treatment }}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Adjuvant Therapy (for guideline-based results) -->
                {% if result.adjuvant_therapy %}
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title"><i class="fas fa-syringe"></i> Adjuvant Therapy Options</h5>
                        {% if result.adjuvant_therapy is mapping %}
                            {% for key, value in result.adjuvant_therapy.items() %}
                            <div class="indication-item">
                                <strong>{{ key.replace('_', ' ').title() }}:</strong> {{ value }}
                            </div>
                            {% endfor %}
                        {% else %}
                            <p>{{ result.adjuvant_therapy }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Matching Indications -->
                {% if result.matching_indications %}
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title"><i class="fas fa-check-double"></i> Matching Indications</h5>
                        <p class="text-muted mb-3">Your symptoms align with these treatment indications:</p>
                        {% for indication in result.matching_indications %}
                        <div class="indication-item">
                            <i class="fas fa-check text-success"></i> {{ indication|title }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Key Metrics -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="urgency-box">
                                    <h6><i class="fas fa-clock"></i> Urgency Level</h6>
                                    <p class="mb-0"><strong>{{ result.urgency }}</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="recovery-box">
                                    <h6><i class="fas fa-heart-pulse"></i> Recovery Time</h6>
                                    <p class="mb-0"><strong>{{ result.recovery_time }}</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="recovery-box" style="background-color: #e3f2fd; border-color: #2196f3;">
                                    <h6><i class="fas fa-heartbeat"></i> Survival Rate</h6>
                                    <p class="mb-0"><strong>{{ result.survival_rate }}</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cost Information -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title"><i class="fas fa-indian-rupee-sign"></i> Estimated Cost</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>India (INR):</strong> {{ result.estimated_cost }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>International (USD):</strong> {{ result.cost_usd }}</p>
                            </div>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> Costs are estimates and may vary based on hospital, location, and specific requirements.
                        </small>
                    </div>
                </div>

                <!-- Potential Risks -->
                {% if result.potential_risks or result.risks %}
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title"><i class="fas fa-exclamation-triangle"></i> Potential Risks & Side Effects</h5>
                        {% for risk in result.get('potential_risks', result.get('risks', [])) %}
                        <div class="risk-item">
                            <i class="fas fa-warning text-warning"></i> {{ risk }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Contraindications (for guideline-based results) -->
                {% if result.contraindications %}
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title"><i class="fas fa-ban"></i> Contraindications</h5>
                        <p class="text-muted mb-3">Conditions where this treatment should be avoided or used with caution:</p>
                        {% for contraindication in result.contraindications %}
                        <div class="contraindication-item">
                            <i class="fas fa-exclamation-circle text-danger"></i> {{ contraindication }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Safe Alternatives -->
                {% if result.safe_alternatives or result.alternative_treatments %}
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title"><i class="fas fa-shuffle"></i> Alternative Treatment Options</h5>
                        <p class="text-muted mb-3">Consider discussing these alternatives with your healthcare provider:</p>
                        
                        {% if result.safe_alternatives %}
                            {% for alt in result.safe_alternatives %}
                            <div class="alternative-card">
                                <h6><i class="fas fa-pills"></i> {{ alt.name }}</h6>
                                {% if alt.reason %}
                                <p class="mb-2">{{ alt.reason }}</p>
                                {% endif %}
                                <div class="row mt-2">
                                    {% if alt.survival_rate %}
                                    <div class="col-md-4">
                                        <small><strong>Survival Rate:</strong> {{ alt.survival_rate }}</small>
                                    </div>
                                    {% endif %}
                                    {% if alt.recovery_time %}
                                    <div class="col-md-4">
                                        <small><strong>Recovery:</strong> {{ alt.recovery_time }}</small>
                                    </div>
                                    {% endif %}
                                    {% if alt.estimated_cost %}
                                    <div class="col-md-4">
                                        <small><strong>Cost:</strong> {{ alt.estimated_cost }}</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% elif result.alternative_treatments %}
                            {% for alt in result.alternative_treatments %}
                            <div class="alternative-card">
                                <i class="fas fa-pills"></i> {{ alt }}
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Myths vs Facts (if available) -->
                {% if result.myths %}
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title"><i class="fas fa-lightbulb"></i> Myths vs Facts</h5>
                        
                        <div class="myth-card">
                            <strong><i class="fas fa-times-circle"></i> MYTH:</strong>
                            <p class="mb-0 mt-2">{{ result.myths.myth1 }}</p>
                        </div>
                        <div class="fact-card">
                            <strong><i class="fas fa-check-circle"></i> FACT:</strong>
                            <p class="mb-0 mt-2">{{ result.myths.fact1 }}</p>
                        </div>
                        
                        <div class="myth-card">
                            <strong><i class="fas fa-times-circle"></i> MYTH:</strong>
                            <p class="mb-0 mt-2">{{ result.myths.myth2 }}</p>
                        </div>
                        <div class="fact-card">
                            <strong><i class="fas fa-check-circle"></i> FACT:</strong>
                            <p class="mb-0 mt-2">{{ result.myths.fact2 }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Official Guidelines References (for guideline-based results) -->
                {% if result.official_guidelines %}
                <div class="card bg-light">
                    <div class="card-body">
                        <h6><i class="fas fa-book-medical"></i> Official Guideline Sources</h6>
                        <p class="mb-2">This analysis is based on internationally recognized oncology guidelines:</p>
                        <ul class="mb-0 small">
                            {% for source, url in result.official_guidelines.items() %}
                            <li>
                                <a href="{{ url }}" target="_blank">{{ source.upper() }} Guidelines <i class="fas fa-external-link-alt"></i></a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endif %}

                <!-- Important Notice -->
                <div class="card bg-light">
                    <div class="card-body">
                        <h6><i class="fas fa-stethoscope"></i> Important Medical Disclaimer</h6>
                        <p class="mb-0">This information is for educational and informational purposes only. It is not intended as medical advice, diagnosis, or treatment. Always seek the advice of your physician or other qualified healthcare providers with any questions regarding your medical condition. Never disregard professional medical advice or delay seeking it because of information provided by this system.</p>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="text-center mt-4 no-print">
                    <a href="/consultation/detail/{{ consultation.id }}/pdf" class="btn btn-success print-btn me-2">
                        <i class="fas fa-file-pdf"></i> Download PDF Report
                    </a>
                    <button onclick="window.print()" class="btn btn-primary print-btn me-2">
                        <i class="fas fa-print"></i> Print / Save as PDF
                    </button>
                    <a href="/consultation" class="btn btn-outline-primary print-btn me-2">
                        <i class="fas fa-plus"></i> New Consultation
                    </a>
                    <a href="/history" class="btn btn-outline-secondary print-btn">
                        <i class="fas fa-history"></i> Back to History
                    </a>
                </div>

                <!-- Print Instructions -->
                <div class="alert alert-info mt-3 no-print">
                    <h6><i class="fas fa-info-circle"></i> Multiple Ways to Save Your Report:</h6>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6><strong>Option 1: Direct PDF Download</strong></h6>
                            <ol class="mb-0">
                                <li>Click <strong>"Download PDF Report"</strong> button above</li>
                                <li>PDF will download automatically</li>
                                <li>Open from your Downloads folder</li>
                            </ol>
                        </div>
                        <div class="col-md-6">
                            <h6><strong>Option 2: Browser Print to PDF</strong></h6>
                            <ol class="mb-0">
                                <li>Click <strong>"Print / Save as PDF"</strong> button</li>
                                <li>Select "Save as PDF" as printer</li>
                                <li>Click Save and choose location</li>
                            </ol>
                        </div>
                    </div>
                    
                    <p class="mt-3 mb-0">
                        <strong>Keyboard Shortcuts:</strong> 
                        <span class="badge bg-secondary">Windows: Ctrl+P</span> 
                        <span class="badge bg-secondary">Mac: Cmd+P</span>
                    </p>
                </div>
            </div>
        </div>
        {% else %}
        <div class="row">
            <div class="col-lg-6 mx-auto">
                <div class="card text-center">
                    <div class="card-body p-5">
                        <i class="fas fa-exclamation-circle fa-4x text-danger mb-4"></i>
                        <h4>Error Loading Report</h4>
                        <p class="text-muted">Unable to load consultation details.</p>
                        <a href="/history" class="btn btn-primary mt-3">
                            <i class="fas fa-arrow-left"></i> Back to History
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>